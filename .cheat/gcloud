# save ssl certificates from database instance

DBINSTANCE="db-1"
PROJECT="gcp-project"
CERTNAME="dev"
gcloud -project $PROJECT sql ssl-certs create $CERTNAME ${CERTNAME}.key -i $DBINSTANCE
gcloud -project $PROJECT sql ssl-certs describe $CERTNAME -i $DBINSTANCE --format="value(cert)" > ${CERTNAME}.pem
gcloud -project $PROJECT sql instances describe $DBINSTANCE --format="value(serverCaCert.cert)" > ca.pem

# pull, re-tag and upload docker images to gcr
gcloud docker -- pull "$GCR_IMAGE:$GCR_TAG"
gcloud docker -- tag "$GCR_IMAGE:$GCR_TAG" "$GCR_IMAGE:$DATA_METABASE_RELEASE_VERSIONNAME"
gcloud docker -- push $GCR_IMAGE

# sql / database backup / export
gcloud --project karhoo-production sql instances export db-1-failover gs://kh-dump/db-1/15-09-2017.sql.gz --async
